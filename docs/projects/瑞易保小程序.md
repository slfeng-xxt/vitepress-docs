# 小程序

:::tip
项目案例：清陶云能微服务（已上线）、瑞易保小程序（未上线）
:::

## 1. 开发前准备

- [HBuilderX 帮助文档手册 & 插件开发文档](https://geekdaxue.co/read/hbuilderx-extension-docs-zh/zh-cn-Tutorial-App-SafePack.md)
- [uniapp 开发微信小程序，从构建到上线](https://blog.csdn.net/u012767761/article/details/142147526)
- [让 uni-app 也能使用 iconfont 多色图标](https://juejin.cn/post/7079674057041395726)
- [微信小程序图片 cdn](http://www.miuqiong.com/da/sanbujiejueweixinxia.html)
- [用好 uni-app 开发小程序，这些组件库了解一下！](https://cloud.tencent.com/developer/article/1645509)
- [小程序运行机制](https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/operating-mechanism.html)
- [使用 uniapp+vite+vue3+uview-plus3.0 搭建的搭建的适合团队协作的快速开发模版](https://github.com/oyjt/uniapp-vue3-template/)

## 2. 遇到的问题

### 2.1 线上版本问题

#### 二次冷启动遇到页面不跳转问题

启动页配置了页面跳转，但是线上版本启动时，页面没有跳转，导致页面停留在启动页。使用了 onLoad 方法，但是 onLoad 方法没有执行。

- [什么情况下小程序打开走了冷启动，但是不走页面的 onLoad](https://www.itcan.cn/2025/06/27/mini-program-onlaunch/)

### 2.2 开发中遇到的问题

#### 静态资源体积太大问题

解决：1. 小程序的本地缓存机制 2.从服务器加载图片

- [小程序-图片/文件本地缓存，减少 CDN 流量消耗 【普通小程序最多可存储 10MB】](https://www.cnblogs.com/CakaSWM/p/13087555.html)
- [小程序图片优化全攻略](https://developers.weixin.qq.com/community/develop/article/doc/0006ae5c7fcc88ee89e0a4e1c63413)
- [微信小程序 cdn 加速（资源大小超过 200k)](http://www.zhangshiyu.com/post/87487.html)
- [使用 uniapp 开发微信小程序时，图片处理最佳实践](https://blog.csdn.net/cnpath/article/details/140232675)
- [uni-app 资源管理与图标使用全解](https://blog.csdn.net/qq_42696432/article/details/143634690)

#### 图片资源适配问题

- [1x，2x，3x 切图是如何适配的？](https://zhuanlan.zhihu.com/p/353830263)
- [小程序怎么处理 2x，3x 图](https://blog.csdn.net/qq_29180565/article/details/102786829)
- [设计稿最好用二倍图｜切图只需切 750 的尺寸](https://www.cainiaoxueyuan.com/xcx/16008.html)

#### 微信小程序包体积限制

- [微信小程序包体积超过 2M 的优化方法](https://blog.csdn.net/q1003675852/article/details/143802389)
- [uni-app 分包解决 echarts.js 文件过大的问题](https://blog.csdn.net/qq_46499695/article/details/124021460)

#### 小程序版本校验

- [微信小程序更新提醒 uniapp](https://developers.weixin.qq.com/community/develop/article/doc/0000e0ef4348f0529142ba4bc6b813)

#### uniapp 监听手机侧滑返回事件

- [uniapp 开发 H5 及 app 监听返回事件](https://developer.aliyun.com/article/1379069)
- [uniapp 如何监听或者知道 ios 左滑返回事件？](https://ask.dcloud.net.cn/question/101333)
- [无侵入式一键实现监听微信小程序手势左滑事件](https://juejin.cn/post/7441916250089652250)

#### 页面跳转传递数据

- [uniapp 之 页面跳转时传递数据](https://blog.csdn.net/weixin_56650035/article/details/119058076)

#### 悬浮按钮

- [lime-fab 浮动气泡-悬浮按钮](https://ext.dcloud.net.cn/plugin?id=13286)
- [uniapp 微信小程序实现全屏悬浮按钮可拖动，自动吸附边缘效果 demo](https://blog.csdn.net/qq_38881495/article/details/131894683)

#### uni.showToast 一闪而过的问题

<https://www.jianshu.com/p/c078d00d2108>
<https://blog.csdn.net/2301_79175212/article/details/148831440>

#### 其他

- [uni-app 小程序 uni.showToast 字数超过两行自动省略显示不全问题](https://blog.csdn.net/maoge_666/article/details/131802277)
- [微信小程序输入框 iphone 会弹出强密码或建议用户名问题](https://blog.csdn.net/weixin_44046951/article/details/144404085)
- [IOS 上微信小程序密码框光标离开提示存储密码解决方案](https://blog.csdn.net/yx_back/article/details/140372921)
- [uniapp input 动态绑定切换 password 和 text 不生效](https://blog.csdn.net/weixin_45586695/article/details/137813292)
- [uniapp 实战教程：如何封装一个可复用的表单组件](https://blog.csdn.net/Jiaberrr/article/details/142627950)
- [uniapp 中 picker 弹窗按钮样式](https://juejin.cn/post/7224074551524655163)
- [colorUI 的样式干扰 uniapp 原生标签样式：colorUI 中 添加条件判断（#ifndef MP-ALIPAY || MP-WEIXIN）](https://www.cnblogs.com/luyj00436/p/15321672.html)
- [富文本回显：v-html 指令](https://blog.csdn.net/My_wife_QBL/article/details/135009900)
- [开发工具中发请求提示 Provisional headers are shown，怎么解决？](https://developers.weixin.qq.com/community/minihome/doc/00002e04d48a9837631fe85fa56400)
- [（优化）表单验证不通过时，滚动到校验未通过位置](https://blog.csdn.net/jxhxisbsbjx/article/details/130383909)
- [生成骨架屏](https://blog.csdn.net/qq_38003956/article/details/131652390)
- [picker 普通选择器和自定义 picker 的用法](https://blog.csdn.net/weixin_44060609/article/details/10636252)
- [组件引入方式](https://gitee.com/dlf123/uni-ui)
- [tab 组件点击效果： 参考图鸟 UI 实现](https://vue3.tuniaokj.com/doc/component/tabs.html)

- 小程序组件——组件样式隔离  
   <https://blog.csdn.net/weixin_39782183/article/details/104767131>

  <https://www.cnblogs.com/skuld-yi/p/15104506.html>

- CSS 实现多行文本“展开收起”【封装为组件】

  <https://zhuanlan.zhihu.com/p/400514833>

  <https://juejin.cn/post/6905368091165720589?from=search-suggest>

  <https://www.cnblogs.com/zsnhweb/p/18195549>

  <https://juejin.cn/post/7236932516741316663>

- 导航栏渐变透明
- 自定义 picker 弹窗功能

<https://blog.csdn.net/qq_40007317/article/details/125721938>

<https://blog.csdn.net/weixin_42100033/article/details/144580958>

- 动态表单文件上传：

<https://blog.csdn.net/weixin_53579656/article/details/131296135>

<https://blog.csdn.net/hou_ge/article/details/131144871>

## 3. 手机号登录

:::tip
**前置条件**

1.【微信开发者资质认证】确保您的小程序已通过微信平台的开发者资质认证，具备获取用户手机号的权限。

2.【基础库版本要求】使用支持获取手机号功能的微信小程序基础库版本。

3.【用户授权】用户必须主动同意授权小程序获取其手机号码。
:::

### 3.1 方式一

#### uni 一键登录

<https://uniapp.dcloud.net.cn/univerify.html#%E4%BA%A7%E5%93%81%E4%BC%98%E5%8A%BF>

PS: 广电卡不支持

### 3.2 方式二

#### 3.2.0 引导用户点击授权获取用户信息，实现一进入微信小程序就弹出授权窗口【@getphonenumber 事件】

<https://blog.csdn.net/u012347650/article/details/139282788>

#### 3.2.1 基础库 2.21.2 版本之后新版

```txt
前端实现：
【https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html】
1.配置按钮组件 open-type
2. 处理@getphonenumber事件 返回code（说明：可通过动态令牌换取用户手机号，每个code有效期为5分钟，且只能消费一次）
3. 用户授权提示弹窗

后端实现：
1. 你的小程序 appId + 你的小程序 appSecret  ==》 accessToken
https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appId}&secret=${appSecret}

2. 消费code 【3种方式： https、云调用、第三方调用】
 2.1 https获取手机号：
https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html
```

#### 3.2.1 基础库 2.21.2 版本之前

```txt
1. uni.login获取code凭证

2. 使用code换取session_key和openid
https://api.weixin.qq.com/sns/jscode2session?appid=${APP_ID}&secret=${APP_SECRET}&js_code=${code}&grant_type=authorization_code

3. 使用session_key和接收到的encryptedData、iv解密手机号
```

## 4. 微信授权登录

- uniapp 小程序实现微信授权登录

```js
//微信快捷登录
const wxLogin = async () => {
  try {
    const userProfile = await uni.getUserInfo({
      provider: "weixin",
      lang: "zh_CN",
    });
    if (userProfile) {
      // 调用微信登录接口获取临时code
      const loginInfo = await uni.login({ provider: "weixin" });
      if (loginInfo && loginInfo.errMsg === "login:ok") {
        // 调用登录后台接口
        const { openId, token } = await authApi.getWxLogin({
          code: loginInfo.code,
        });
        if (!openId) return (isAccountLogin.value = true);
        if (token === null) {
          // TODO: 已有账号登录或者微信一键注册
          wxOpenId.value = openId;
          isAccountLogin.value = false;
        } else {
          // TODO: 保存token, 进入首页
          store.commit("SET_token", token);
          getLoginInfo();
        }
      }
    }
  } catch (error) {
    console.log(error);
  }
};
```

## 5. H5 迁移小程序

- [参考清陶 H5 迁移](/projects/清陶H5.html#_5-h5迁移到小程序)

## 6. 小程序和 h5 页面交互

### 6.1 准备工作

- uniapp 小程序与 H5 之间的通信
  <https://www.cnblogs.com/jolin-qin/p/17879636.html>

- uniapp: web-view
  <https://uniapp.dcloud.net.cn/component/web-view.html#getenv>

- uniapp 中微信小程序与 H5 相互跳转以及传参详解(webview)
  <https://www.zhangshengrong.com/p/RmNPAn2AXk/>

### 6.2 实现功能

:::tip
实现功能：小程序中通过绑定公众号平台来实现告警通知的功能

实现过程：小程序通过 web-view 加载 H5 页面，H5 页面通过 postMessage 向小程序发送消息，小程序通过 onMessage 接收消息

材料：web-view、auth.html、callback.html
:::

- 1.小程序准备一个 web-view 组件，用于加载 H5 页面（⚠️ 注：小程序中 web-view 的 src 只能是线上.html）
- 2.准备一个 auth.html 文件，用来接收小程序的跳转参数，并跳转到微信认证页面
- 3.准备一个 callback.html 文件，用来接收微信认证后的回调，并通过 postMessage 传递信息并跳转回小程序结果页面

```js
// auth.html
// 获取URL参数
function getUrlParam(name) {
  const reg = new RegExp(`(^|&)${name}=([^&]*)(&|$)`);
  const r = window.location.search.substr(1).match(reg);
  if (r != null) return decodeURIComponent(r[2]);
  return null;
}

// 页面加载完成后跳转
window.onload = function () {
  const authUrl = getUrlParam("url");
  if (authUrl) {
    window.location.href = authUrl;
  } else {
    document.getElementById("error").innerText = "缺少授权链接参数";
  }
};
```

```js
// callback.html
// 获取URL参数
function getUrlParam(name) {
  const reg = new RegExp(`(^|&)${name}=([^&]*)(&|$)`);
  const r = window.location.search.substr(1).match(reg);
  if (r != null) return decodeURIComponent(r[2]);
  return null;
}

// 检查是否在小程序webview环境中
function isInWechatMiniProgram() {
  return typeof wx !== "undefined" && wx.miniProgram;
}

// 向小程序发送消息
function sendMessageToMiniProgram(message) {
  if (isInWechatMiniProgram()) {
    // 使用微信JS-SDK向小程序发送消息
    wx.miniProgram.postMessage({
      data: message,
    });

    setTimeout(() => {
      wx.miniProgram.navigateBack();
    }, 3000);
  } else {
    console.log("非小程序环境，消息内容:", message);
    // 如果在普通浏览器中，显示关闭按钮
    document.getElementById("errorMessage").innerText =
      "请在微信小程序中打开此页面";
    showError();
  }
}

// 发送回调请求到后端 - 使用GET方法
async function handleCallback() {
  const code = getUrlParam("code");
  const state = getUrlParam("state");

  console.log("获取到参数:", { code, state });

  if (!code) {
    showError("授权失败：未获取到授权码");
    // 发送错误消息给小程序
    sendMessageToMiniProgram({
      type: "ERROR",
      code: 500,
      msg: "授权失败，未获取到授权码",
    });
    return;
  }

  if (!state) {
    showError("授权失败：状态参数缺失");
    // 发送错误消息给小程序
    sendMessageToMiniProgram({
      type: "ERROR",
      code: 500,
      msg: "授权失败，状态参数缺失",
    });
    return;
  }

  try {
    const baseUrl = "https://xxxxxx/api";
    // 使用GET请求，参数通过URL传递
    const response = await axios.get(baseUrl + "/sys/wechat/mp/callback", {
      params: {
        code: code,
        state: state,
      },
    });

    console.log("后端响应:", response.data);

    // 根据后端返回的code字段判断成功与否
    const resCode = response.data.code;
    const msg = response.data.msg;
    const data = response.data.data;
    if (resCode === 200) {
      if (data && data.subscribeStatus && data.bindStatus) {
        showSuccess("授权成功！即将返回小程序...");
        // 发送成功消息给小程序
        const messageData = {
          type: "SUCCESS",
          code: resCode,
          msg: msg,
          data: data,
        };
        sendMessageToMiniProgram(messageData);
      }
    }
  } catch (error) {
    console.error("回调处理失败:", error);
    let errorMessage = error.message;

    if (error.response) {
      // 请求已发出，服务器响应的状态码不在 2xx 范围内
      errorMessage = `服务器错误: ${error.response.status}`;
      if (error.response.data && error.response.data.msg) {
        errorMessage = error.response.data.msg;
      }
    } else if (error.request) {
      // 请求已发出但没有收到响应
      errorMessage = "网络连接失败，请检查网络设置";
    }

    showError(errorMessage);
    // 发送错误消息给小程序
    sendMessageToMiniProgram({
      type: "ERROR",
      code: 500,
      msg: errorMessage,
    });
  }
}

// 页面加载完成后处理回调
window.onload = function () {
  // 检查必要的参数
  const code = getUrlParam("code");
  const state = getUrlParam("state");

  if (!code || !state) {
    showError("页面参数不完整，请重新从小程序发起授权");
    return;
  }

  handleCallback();
};

// 处理页面可见性变化，防止页面被挂起时操作中断
document.addEventListener("visibilitychange", function () {
  if (!document.hidden) {
    // 页面重新可见时，检查是否已经完成处理
    const code = getUrlParam("code");
    const state = getUrlParam("state");

    if (
      code &&
      state &&
      document.getElementById("loading").style.display !== "none"
    ) {
      // 如果还在加载中，重新处理（防止网络请求被中断）
      console.log("页面重新可见，重新处理回调");
      handleCallback();
    }
  }
});
```

```vue
// pages/auth/auth.vue
<template>
  <view>
    <web-view :src="authUrl" @message="reciveMessage"></web-view>
  </view>
</template>

<script setup>
import { ref } from "vue";
import store from "@/store";
import { onLoad } from "@dcloudio/uni-app";

const authUrl = ref("");
onLoad((options) => {
  if (options.url) {
    // 进入h5页面，获取url参数，并拼接授权链接
    authUrl.value = `https://xxxxx/auth.html?url=${options.url}`;
  } else {
    uni.showToast({
      title: "缺少参数",
      icon: "error",
    });
  }
});

// 接收消息
const reciveMessage = (data) => {
  try {
    const reciveData = data.detail.data[0];
    // reciveData: {data: "{"subscribeStatus":false}"}}
    if (reciveData.code === 200) {
      if (!reciveData.data.subscribeStatus) {
        // 未订阅，存储状态，返回上一页展示二维码引导关注
        store.commit("SET_subscribeStatus", false);
      } else {
        store.commit("SET_subscribeStatus", true); // 重置订阅状态
        uni.navigateBack(); // 多一次返回
      }
    } else {
      uni.showToast({
        title: reciveData.msg,
        icon: "error",
      });
    }
  } catch (error) {
    uni.showToast({
      title: error,
      icon: "error",
      success: () => {
        uni.navigateBack();
      },
    });
  }
};
</script>

```

## 小程序云开发 TODO
