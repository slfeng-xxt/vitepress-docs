# GC（garbage collection）

## 介绍

程序工作过程中会产生很多 垃圾，这些垃圾是程序不用的内存或者是之前用过了，以后不会再用的内存空间，而 GC 就是负责回收垃圾的，因为他工作在引擎内部，所以对于我们前端来说，GC 过程是相对比较无感的，这一套引擎执行而对我们又相对无感的操作也就是常说的 垃圾回收机制 了
当然也不是所有语言都有 GC，一般的高级语言里面会自带 GC，比如 Java、Python、JavaScript 等，也有无 GC 的语言，比如 C、C++ 等，那这种就需要我们程序员手动管理内存了，相对比较麻烦

## 回收方式♻️

- 引用计数算法

```txt
- 当声明了一个变量并且将一个引用类型赋值给该变量的时候这个值的引用次数就为 1
- 如果同一个值又被赋给另一个变量，那么引用数加 1
- 如果该变量的值被其他的值覆盖了，则引用次数减 1
- 当这个值的引用次数变为 0 的时候，说明没有变量在使用，这个值没法被访问了，回收空间，垃圾回收器会在运行的时候清理掉引用次数为 0 的值占用的内存
```

- 标记清除（mark-sweep）算法
  目前在 JavaScript 引擎 里这种算法是最常用的，到目前为止的大多数浏览器的 JavaScript 引擎 都在采用标记清除算法，各大浏览器厂商还对此算法进行了优化加工，且不同浏览器的 JavaScript 引擎 在运行垃圾回收的频率上有所差异。

```txt
1. 垃圾收集器在运行时会给内存中的所有变量都加上一个标记，假设内存中所有对象都是垃圾，全标记为0
2. 然后从各个根对象开始遍历，把不是垃圾的节点改成1
3. 清理所有标记为0的垃圾，销毁并回收它们所占用的内存空间
4. 最后，把所有内存中对象标记修改为0，等待下一轮垃圾回收
```

## 内存管理

V8 的垃圾回收策略主要基于分代式垃圾回收机制，V8 中将堆内存分为新生代和老生代两区域，采用不同的垃圾回收器也就是不同的策略管理垃圾回收

- 新生代
- 老生代
- 并行回收
- 并发回收

### 教程

[JavaScript 内存泄漏教程](https://ruanyifeng.com/blog/2017/04/memory-leak.html)

## Q1. 怎么理解内存泄漏?

原因：
全局变量：过度分配的全局变量会导致内存泄漏。
闭包：不当使用的闭包可能会导致内存泄漏。
定时器和回调函数：未正确清理的定时器和回调函数可能会导致内存泄漏。
事件监听器：未正确移除的事件监听器可能会导致内存泄漏。

解决：
避免过度分配全局变量，可以使用局部变量代替。
合理使用闭包，确保闭包外部不再引用闭包内部的变量。
清除不再使用的定时器和回调函数。
使用事件池等技术确保事件监听器的正确管理。

## Q2. 怎么解决内存泄漏，代码层面如何优化？

### 1. 减少查找

```js
var i,
  str = "";
function packageDomGlobal() {
  for (i = 0; i < 1000; i++) {
    str += i;
  }
}

// 第二种情况。我们采用局部变量来保存保存相关数据
function packageDomLocal() {
  let str = "";
  for (let i = 0; i < 1000; i++) {
    str += i;
  }
}
```

### 2. 减少变量声明

```js
// 第一种情况，循环体中没有抽离出值不变的数据
var test = () => {
  let arr = ["czs", 25, "I love FrontEnd"];
  for (let i = 0; i < arr.length; i++) {
    console.log(arr[i]);
  }
};

// 第二种情况，循环体中抽离出值不变的数据
var test = () => {
  let arr = ["czs", 25, "I love FrontEnd"];
  const length = arr.length;
  for (let i = 0; i < length; i++) {
    console.log(arr[i]);
  }
};
```

### 3. 使用 Performance + Memory 分析内存与性能

参考链接：

- [前端调试](https://www.cnblogs.com/leise/p/17035684.html)
- [内存泄露分析](https://juejin.cn/post/6844904082918899720)
- [JavaScript 性能优化：调优策略与工具使用](https://juejin.cn/post/7506110991051243583)
